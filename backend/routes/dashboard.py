# backend/routers/dashboard.py
from fastapi import APIRouter, Depends
from sqlalchemy.orm import Session
from typing import Dict, Any
from .. import database

router = APIRouter(prefix="/dashboard", tags=["dashboard"])

# ğŸ“Œ ì±Œë¦°ì§€ ëª©í‘œ (ì˜ˆì‹œ: 100kg ì ˆê°)
CHALLENGE_GOAL_KG = 100

@router.get("/{user_id}")
def get_dashboard(user_id: int, db: Session = Depends(database.get_db)) -> Dict[str, Any]:
    """
    ëŒ€ì‹œë³´ë“œ í†µí•© API
    - ì˜¤ëŠ˜ ì ˆì•½ëŸ‰
    - ì˜¤ëŠ˜ íšë“ í¬ì¸íŠ¸
    - ì •ì› ë ˆë²¨
    - ëˆ„ì  ì ˆì•½ëŸ‰
    - ìµœê·¼ 7ì¼ ì ˆê°ëŸ‰
    - êµí†µìˆ˜ë‹¨ë³„ ì ˆê° ë¹„ìœ¨
    - ì±Œë¦°ì§€ ì§„í–‰ ìƒí™©
    """

    # ğŸ“Œ ì˜¤ëŠ˜ ì ˆì•½ëŸ‰
    today_query = """
        SELECT IFNULL(SUM(co2_saved_g), 0) AS saved_today
        FROM mobility_logs
        WHERE user_id = :user_id AND DATE(created_at) = CURDATE()
    """
    today_row = db.execute(today_query, {"user_id": user_id}).fetchone()
    co2_saved_today = float(today_row[0]) if today_row else 0.0

    # ğŸ“Œ ëˆ„ì  ì ˆì•½ëŸ‰
    total_query = """
        SELECT IFNULL(SUM(co2_saved_g), 0) AS total_saved
        FROM mobility_logs
        WHERE user_id = :user_id
    """
    total_row = db.execute(total_query, {"user_id": user_id}).fetchone()
    total_saved = float(total_row[0]) if total_row else 0.0

    # ğŸ“Œ ìµœê·¼ 7ì¼ ì ˆê°ëŸ‰
    daily_query = """
        SELECT DATE(created_at) AS ymd, SUM(co2_saved_g) AS saved_g
        FROM mobility_logs
        WHERE user_id = :user_id
          AND created_at >= CURDATE() - INTERVAL 7 DAY
        GROUP BY DATE(created_at)
        ORDER BY ymd ASC
    """
    daily_rows = db.execute(daily_query, {"user_id": user_id}).fetchall()
    last7days = [{"date": str(row[0]), "saved_g": float(row[1])} for row in daily_rows]

    # ğŸ“Œ êµí†µìˆ˜ë‹¨ë³„ ì ˆê° ë¹„ìœ¨
    mode_query = """
        SELECT mode, SUM(co2_saved_g) AS saved_g
        FROM mobility_logs
        WHERE user_id = :user_id
        GROUP BY mode
    """
    mode_rows = db.execute(mode_query, {"user_id": user_id}).fetchall()
    modeStats = [{"mode": row[0], "saved_g": float(row[1])} for row in mode_rows]

    # ğŸ“Œ ì •ì› ë ˆë²¨, ì—ì½” í¬ë ˆë”§, í¬ì¸íŠ¸ (ì„ì‹œ ê·œì¹™)
    garden_level = int(total_saved // 100)          # 100gë‹¹ ë ˆë²¨ 1
    eco_credits_earned = int(co2_saved_today // 10) # ì˜¤ëŠ˜ 10g ì ˆì•½ë‹¹ 1P
    total_points = int(total_saved // 10)           # ëˆ„ì  10g ì ˆì•½ë‹¹ 1P

    # ğŸ“Œ ì±Œë¦°ì§€ ì§„í–‰ ìƒí™©
    challenge = {
        "goal": CHALLENGE_GOAL_KG,
        "progress": total_saved / 1000  # g â†’ kg ë³€í™˜ (mobility_logs ë‹¨ìœ„ í™•ì¸ í•„ìš”)
    }

    return {
        "user_id": user_id,
        "co2_saved_today": co2_saved_today,
        "eco_credits_earned": eco_credits_earned,
        "garden_level": garden_level,
        "total_saved": total_saved / 1000,  # g â†’ kg ë³€í™˜
        "total_points": total_points,
        "last7days": last7days,
        "modeStats": modeStats,
        "challenge": challenge
    }
